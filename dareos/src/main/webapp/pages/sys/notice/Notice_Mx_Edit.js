/** * @module 消息管理 * @fuc 公告生效区域 * @version 1.1 * @author 张忠斌 */$(function(){ 	init();//页面初始化	$("#add").click(function(){	    addRow();	});		$("body").dblclick(function(){	    addRow();	});		$("#delete").click(function(){		//查找当前是否有选中的记录		var checkBox = $("#jsontb tr:gt(0) input:checked");		if(checkBox.length<1){			parent.showErrorMsg("请至少选择一条记录");			return;		}		//获取所有选中的记录		var ids = "";		checkBox.each(function(){			if("" != $(this).val()){				ids = ids+"'"+$(this).val()+"',";			}		});		ids = ids.substr(0,ids.length-1);		//没有ids说明都是页面新增的，数据库中无记录，可以直接remove		if("" == ids){			checkBox.parent().parent().remove();		}else{			parent.showConfirm("您确认要删除吗","bottomcontent.multiRecDeletes();");		}		//删除后scroll可能消失，因此需要重新调整浮动按钮的位置		setFloatPostion();	});		$("#save").click(function(){		//当前所在页面有2种可能，列表展示页面，编辑页面。		var actionType = getActionType();		if("list" == actionType){			//查找当前是否有选中的记录			var checkBox = $("#jsontb tr:gt(0) input:checked");			if(checkBox.length<1){				parent.showErrorMsg("请至少选择一条记录");				return;			}			//对于选中的明细校验			if(!formMutiTrChecked()){				return;			}			//页面 查重			if(dataColumnsValidation("jsontb",['AREA_NO'],"red")){				childSave();			}					}else{			//编辑页面，子表没有选中记录也可以提交，故不需要校验。			//allSave();		}	});		$("#allChecked").click(function(){		var flag = document.getElementById("allChecked").checked;		if(flag){			$("#jsontb :checkbox").attr("checked","true");		}else{			$("#jsontb :checkbox").removeAttr("checked");		}	});});//子表保存function childSave(){		//查找当前是否有选中的记录	var checkBox = $("#jsontb tr:gt(0) input:checked");	//获取所有选中的记录	var ids = "";	checkBox.each(function(){		var id = $(this).val();		if(null != id & ""!=id){			ids = ids+"'"+id+"',";		}			});	ids = ids.substr(0,ids.length-1);		var selRowId = getSelRowId();	var jsonData = multiPackJsonData();	$.ajax({		url: "notice.shtml?action=childEdit",		type:"POST",		dataType:"text",		data:{"childJsonData":jsonData,"NOTICEID":selRowId,"MXIDS":ids},		complete: function(xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				parent.showMsgPanel("保存成功");				parent.window.gotoBottomPage("label_1");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}//删除操作function multiRecDeletes(){//查找当前是否有选中的记录	var checkBox = $("#jsontb tr:gt(0) input:checked");	//获取所有选中的记录	var ids = "";	var areaIds = "";	checkBox.each(function(){		ids = ids+"'"+$(this).val()+"',";	});	ids = ids.substr(0,ids.length-1);	var selRowId = getSelRowId();	$.ajax({		url: "notice.shtml?action=childDelete",		type:"POST",		dataType:"text",		data:{"MXIDS":ids,"NOTICEID":selRowId},		complete: function(xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				parent.showMsgPanel("删除成功");				checkBox.parent().parent().remove();				//设置删除操作。有删除时返回后需要刷新页面。否则直接跳转上一页。				$("#delFlag").val("true");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}	function allSave(){	//主表form校验	var parentCheckedRst = parent.topcontent.formChecked('mainForm');	if(!parentCheckedRst){		return;	}	//明细校验	if(!formMutiTrChecked()){		return;	}	var selRowId = getSelRowId();		//查找当前是否有选中的记录	var checkBox = $("#jsontb tr:gt(0) input:checked");	//获取所有选中的记录	var ids = "";	checkBox.each(function(){		ids = ids+"'"+$(this).val()+"',";	});	ids = ids.substr(0,ids.length-1);			//获取json数据	var parentData = parent.topcontent.siglePackJsonData();	var childData;	if($("#jsontb tr:gt(0) input:checked").length>0){		if(dataColumnsValidation("jsontb",['PRD_NO'],"red")){//页面查重			childData = multiPackJsonData();		}else{         	return;	    }	}	 	$.ajax({		url: "notice.shtml?action=edit",		type:"POST",		dataType:"text",		data:{"parentJsonData":parentData,"childJsonData":childData,"NOTICEID":selRowId,"MXIDS":ids},		complete: function (xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				saveSuccess("保存成功","notice.shtml?action=toFrame");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}function gobacknew(){   newGoBack("notice.shtml?action=toFrame");}			//table增加一行function addRow(arrs){	if(null == arrs){		arrs = ['','','',''];	}	//样式行	var rownum = $("#jsontb tr").length;	var classrow = rownum% 2;	rownum=_row_num;_row_num++;	$("#jsontb tr:last-child").after("<tr class='list_row"+classrow+"' onmouseover='mover(this)' onmouseout='mout(this)'></tr>");	$("#jsontb tr:last-child")		    .append("<td nowrap align='center'><input type='checkbox' style='height:12px;valign:middle' json='NOTC_AREA_ID' name='NOTC_AREA_ID"+rownum+"' value='"+arrs[0]+"'/></td>")		    .append('<input type="hidden" name="AREA_ID'+rownum+'" id="AREA_ID'+rownum+'" json="AREA_ID" value="'+arrs[1]+'" />')		    .append('<td nowrap align="left"><input type="text" json="AREA_NO" id="AREA_NO'+rownum+'" name="AREA_NO"  '			+' autocheck="true" seltarget="selMX" inputtype="string" label="区域编号" mustinput="true"  maxlength="32" READONLY value="'+arrs[2]+'"size="32" />&nbsp;' +		    '<img align="absmiddle" name="selMX" style="cursor:hand" src="/sleemon/styles/newTheme/images/plus/select.gif"'             +'onClick="selArea('+rownum+')"> </td>')		   .append('<td nowrap align="left"><input type="text" json="AREA_NAME" id="AREA_NAME'+rownum+'" seltarget="selMX" READONLY name="AREA_NAME'+rownum+'"  autocheck="true" mustinput="true" inputtype="string" label="区域名称" maxlength="50" value="'+arrs[3]+'"size="32"/>&nbsp;</td>')		        $("#jsontb tr:last-child").find("td:gt(0)").click(function(){		$(this).parent().find("input[type='checkbox']").attr("checked","checked");	});	//form校验设置	trCheckInit($("#jsontb tr:gt(0) input"));	trCheckInit($("#jsontb tr:gt(0) select"));	//InitFormValidator(0);}function init(){	$("#jsontb tr").each(function(){		$(this).find("td:gt(0)").click(function(){			$(this).parent().find("input[type='checkbox']").attr("checked","checked");		});	});	var actionType = parent.document.getElementById("actionType").value;    $("#jsontb tr:gt(0) :checkbox").attr("checked","true");	//form校验设置	InitFormValidator(0);}function getActionType(){	return parent.document.getElementById("actionType").value;}function getSelRowId(){	return parent.document.getElementById("selRowId").value;}function selArea(rownum){	var rtnArr = selCommon("BS_18", true, "AREA_ID"+rownum, "AREA_ID","forms[0]","AREA_NO"+rownum+",AREA_NAME"+rownum, "AREA_NO,AREA_NAME", "selectContion")	multiSelCommonSet(rtnArr,"AREA_ID,AREA_NO,AREA_NAME",rownum);}